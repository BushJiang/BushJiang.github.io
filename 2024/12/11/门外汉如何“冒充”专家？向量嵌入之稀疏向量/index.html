

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/profile_picture.png">
  <link rel="icon" href="/img/profile_picture.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="爱写作的CAE工程师">
  <meta name="keywords" content="">
  
    <meta name="description" content="在 [[02-孙悟空 + 红楼梦 - 西游记 &#x3D; ？向量嵌入之稠密向量]]这篇文章中，我们已经知道了文本怎么变成稠密向量，并且还能够表达文本的语义。但是，对于嵌入模型的“专业领域”外的文本，它的效果不尽如人意。 打个比方，假设你身体不舒服去看医生，医生完全理解你的描述，他会判断病因然后做出诊断。但是，如果你问医生“人工智能如何影响汽车行业？”，医生大概会觉得你不仅身体不舒服，脑子也需要治">
<meta property="og:type" content="article">
<meta property="og:title" content="门外汉如何“冒充”专家？向量嵌入之稀疏向量">
<meta property="og:url" content="http://example.com/2024/12/11/%E9%97%A8%E5%A4%96%E6%B1%89%E5%A6%82%E4%BD%95%E2%80%9C%E5%86%92%E5%85%85%E2%80%9D%E4%B8%93%E5%AE%B6%EF%BC%9F%E5%90%91%E9%87%8F%E5%B5%8C%E5%85%A5%E4%B9%8B%E7%A8%80%E7%96%8F%E5%90%91%E9%87%8F/index.html">
<meta property="og:site_name" content="江浩探索AI大陆">
<meta property="og:description" content="在 [[02-孙悟空 + 红楼梦 - 西游记 &#x3D; ？向量嵌入之稠密向量]]这篇文章中，我们已经知道了文本怎么变成稠密向量，并且还能够表达文本的语义。但是，对于嵌入模型的“专业领域”外的文本，它的效果不尽如人意。 打个比方，假设你身体不舒服去看医生，医生完全理解你的描述，他会判断病因然后做出诊断。但是，如果你问医生“人工智能如何影响汽车行业？”，医生大概会觉得你不仅身体不舒服，脑子也需要治">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-12-11T03:29:14.000Z">
<meta property="article:modified_time" content="2025-01-19T03:31:07.873Z">
<meta property="article:author" content="江浩">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>门外汉如何“冒充”专家？向量嵌入之稀疏向量 - 江浩探索AI大陆</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":4},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>江浩探索AI大陆</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">门外汉如何“冒充”专家？向量嵌入之稀疏向量</span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        爱写作的CAE工程师
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-11 11:29" pubdate>
          2024年12月11日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">门外汉如何“冒充”专家？向量嵌入之稀疏向量</h1>
            
            
              <div class="markdown-body">
                
                <p>在 [[02-孙悟空 + 红楼梦 - 西游记 &#x3D; ？向量嵌入之稠密向量]]这篇文章中，我们已经知道了文本怎么变成稠密向量，并且还能够表达文本的语义。但是，对于嵌入模型的“专业领域”外的文本，它的效果不尽如人意。</p>
<p>打个比方，假设你身体不舒服去看医生，医生完全理解你的描述，他会判断病因然后做出诊断。但是，如果你问医生“人工智能如何影响汽车行业？”，医生大概会觉得你不仅身体不舒服，脑子也需要治一治。医生不懂这方面的知识。</p>
<p>想要获得答案，你可以去找人工智能或者汽车领域的专家。当然，你还有另一个选择，去找一位聪明的门外汉，“冒充”专家。</p>
<blockquote>
<p>本文首发于 Zilliz 公众号。文中代码的 Notebook 在<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1TCCz9KZelyNFgiUyPIvVnQ?pwd=9zh6">这里</a>下载。</p>
</blockquote>
<h2 id="聪明的门外汉——BM25"><a href="#聪明的门外汉——BM25" class="headerlink" title="聪明的门外汉——BM25"></a>聪明的门外汉——BM25</h2><p>稠密向量（Dense Vector）的维度较低，一般在几百到上千左右，每个维度的元素一般都不为零。相对的，还有一种稀疏向量（Sparse Vector），它的维度远远超过稠密向量，一般有几万甚至十万，但是大部分维度的元素都为零，只有少数元素是非零的。</p>
<p>稀疏向量分成统计得到的稀疏向量和学习得到的稀疏向量两种，我们先聊聊第一种，代表就是 BM25。</p>
<p>BM25 是一位聪明的门外汉，你问他领域外的知识，他虽然不理解，但是他会找到问题中的关键词，比如“人工智能”和“汽车”，然后去查文档，把文档中和关键词最相关的信息告诉你。</p>
<p>那么，这位门外汉具体是怎么做的呢？</p>
<p>首先，他会搜索成百上千篇相关文档，并且快速地翻一遍，了解这些文档中有哪些专业术语。什么样的词是专业术语呢？作为一个聪明的门外汉，他决定通过单词出现的频率判断。像“的”、“是”、“了”等常见词肯定不是专业术语，反而是那些出现频率比较低的词，更可能是专业术语。</p>
<p>这就好比你有两个微信群，一个是工作群，平时消息不多，但是一旦有消息，不是领导布置任务，就是同事反馈进度，都很重要，你把这个群置顶了。</p>
<p>另一个是吃喝玩乐群，一群朋友在群里聊天吹水，一整天消息不断，但是没那么重要，错过就错过了，忙的时候你还会设置成“信息免打扰”。</p>
<p>对你来说，不同的群权重不同，门外汉也会为不同的词设置不同的权重。他会为文档中出现的词建立一个词汇表，并且根据单词出现的频率赋予权重，出现的频率越低，权重越大，越可能是专业术语。</p>
<p>然后，他要判断哪些文档和“人工智能”以及“汽车”这两个专业术语更相关。他会对照词汇表，数一数每篇文档中这两个术语出现的频率，频率越高，相关性越大。</p>
<p>以上是 BM25 的极简版解释，实际算法要复杂很多。公式越多，读者越少，所以下面我就简单介绍下 BM25 算法的工作原理。</p>
<p>首先，BM25对文档集合做分词处理，得到一张词汇表。词汇表的单词（准确来说是 token）的数量，就是稀疏向量的维度。</p>
<p>然后，对查询也做分词处理，比如，如果查询是“人工智能如何影响汽车行业？”，分词得到“人工智能“”、“影响”和“汽车行业”这三个词。</p>
<p>接下来，计算<strong>文档集合中的每个词</strong>的逆文档频率 IDF，以及<strong>查询中的某个词在指定文档</strong>中的词频 TF。</p>
<p>逆文档频率 IDF（Inverse Document Frequency），很绕口的一个名字。简单来说，它用来计算某个词在<strong>文档集合</strong>中出现的次数。出现次数越少，数值越大。门外汉用它给出现频率低的专业术语，赋予更大的权重。</p>
<p>$$<br>\text{IDF}(q_i) &#x3D; \log \left( \frac{N - n(q_i) + 0.5}{n(q_i) + 0.5} \right)<br>$$</p>
<p>其中：</p>
<ul>
<li>${IDF}(q_i)$ 是单词 $q_i$ 的逆文档频率。</li>
<li>$N$ 是文档总数。</li>
<li>$n(q_i)$ 是语料库中，包含查询词 $(q_i)$ 的文档数量。</li>
<li>$0.5$ 是一个平滑因子，用于避免分母为零的情况。</li>
</ul>
<p>词频TF（Term Frequency）表示查询中的某个词，在<strong>指定文档</strong>中出现的频率，频率越大数值越大，也就意味着查询和该文档的相关性更高。</p>
<p>$$<br>\text{TF}(q_i, d) &#x3D; \frac{f(q_i, d) \cdot (k_1 + 1)}{f(q_i, d) + k_1 \cdot (1 - b + b \cdot \frac{|d|}{\text{avgdl}})}<br>$$<br>其中：</p>
<ul>
<li>${TF}(q_i, d)$ 是查询词 $q_i$ 在文档 $d$ 中的词频。反映了查询词在文档中的重要性。</li>
<li>$q$ 是查询。</li>
<li>$d$ 是语料库中的某一个文档。</li>
<li>$q_i$ 是查询中的第 $i$ 个 token。</li>
<li>$f (q_i, d)$ 是查询词 $q_i$ 在文档 $d$ 中出现的次数。</li>
<li>$k_1$ ​ 是一个调节参数，用于控制词频的影响。 $k_1$ 取值在1.2到2之间</li>
<li>$b$ 是一个调节参数，用于控制文档长度对词频的影响。$b$ 取值为0.75。</li>
<li>$|d|$ 是文档的长度。文档长度指的是分词后的 token 数量。</li>
<li>${avgdl}$ 是语料库中所有文档的平均长度。</li>
</ul>
<p>最后，根据 IDF 和 TF 计算 BM25分数，用来表示查询与指定文档的相关程度。</p>
<p>$$\text{BM25}(q, d) &#x3D; \sum_{i&#x3D;1}^{n} \text{IDF}(q_i) \cdot \text{TF}(q_i, d)$$</p>
<h2 id="BM25-代码实践"><a href="#BM25-代码实践" class="headerlink" title="BM25 代码实践"></a>BM25 代码实践</h2><p>好啦，纸上谈兵到此结束，下面我们用代码实际操练一番吧。先做点准备工作。</p>
<p>版本说明：<br>Milvus 版本：&gt;&#x3D;2.5.0<br>pymilvus 版本：&gt;&#x3D;2.5.0</p>
<p>假如下面的字符串列表就是我们的文档集合，每个字符串是一个文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">docs = [<br>    &quot;机器学习正在改变我们的生活方式。&quot;,<br>    &quot;深度学习在图像识别中表现出色。&quot;,<br>    &quot;自然语言处理是计算机科学的重要领域。&quot;,<br>    &quot;自动驾驶依赖于先进的算法。&quot;,<br>    &quot;AI可以帮助医生诊断疾病。&quot;,<br>    &quot;金融领域广泛应用数据分析技术。&quot;,<br>    &quot;生产效率可以通过自动化技术提高。&quot;,<br>    &quot;机器智能的未来充满潜力。&quot;,<br>    &quot;大数据支持是机器智能发展的关键。&quot;,<br>    &quot;量子隧穿效应使得电子能够穿过经典力学认为无法穿过的势垒，这在半导体器件中有着重要的应用。&quot;<br>]<br></code></pre></td></tr></table></figure>

<p>使用BM25对第一个文档“机器学习正在改变我们的生活方式。”做分词处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pymilvus.model.sparse.bm25.tokenizers <span class="hljs-keyword">import</span> build_default_analyzer<br><span class="hljs-keyword">from</span> pymilvus.model.sparse <span class="hljs-keyword">import</span> BM25EmbeddingFunction<br><br><span class="hljs-comment"># 使用支持中文的分析器</span><br>analyzer = build_default_analyzer(language=<span class="hljs-string">&quot;zh&quot;</span>)<br><br><span class="hljs-comment"># 分析器对文本做分词处理</span><br>tokens1 = analyzer(docs[<span class="hljs-number">0</span>])<br><span class="hljs-built_in">print</span>(tokens1)<br></code></pre></td></tr></table></figure>

<p>分词结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[&#x27;机器&#x27;, &#x27;学习&#x27;, &#x27;改变&#x27;, &#x27;生活&#x27;, &#x27;方式&#x27;]<br></code></pre></td></tr></table></figure>

<p>接下来对整个文档集合做分词处理，并且计算文档集合的 IDF 等参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 创建BM25EmbeddingFunction实例，传入分词器，以及其他参数</span><br>bm25_ef = BM25EmbeddingFunction(analyzer)<br><br><span class="hljs-comment"># 计算文档集合的参数</span><br>bm25_ef.fit(docs)<br><br><span class="hljs-comment"># 保存训练好的参数到磁盘以加快后续处理</span><br>bm25_ef.save(<span class="hljs-string">&quot;bm25_params.json&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>我们看下参数有哪些内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><br>file_path = <span class="hljs-string">&quot;bm25_params.json&quot;</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    bm25_params = json.load(file)<br>    <span class="hljs-built_in">print</span>(bm25_params)<br></code></pre></td></tr></table></figure>

<p><code>corpus_size</code> 是文档数量，<code>avgdl</code>、<code>idf_value</code> 等参数都在前面的公式中出现过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&#123;&#x27;version&#x27;: &#x27;v1&#x27;, &#x27;corpus_size&#x27;: 10, &#x27;avgdl&#x27;: 5.4, &#x27;idf_word&#x27;: [&#x27;机器&#x27;, &#x27;学习&#x27;, &#x27;改变&#x27;, &#x27;生活&#x27;, &#x27;方式&#x27;, &#x27;深度&#x27;, &#x27;图像识别&#x27;, &#x27;中&#x27;, &#x27;表现出色&#x27;, &#x27;自然语言&#x27;, &#x27;计算机科学&#x27;, &#x27;领域&#x27;, &#x27;自动&#x27;, &#x27;驾驶&#x27;, &#x27;依赖于&#x27;, &#x27;先进&#x27;, &#x27;算法&#x27;, &#x27;AI&#x27;, &#x27;医生&#x27;, &#x27;诊断&#x27;, &#x27;疾病&#x27;, &#x27;金融&#x27;, &#x27;广泛应用&#x27;, &#x27;数据分析&#x27;, &#x27;技术&#x27;, &#x27;生产&#x27;, &#x27;效率&#x27;, &#x27;自动化&#x27;, &#x27;提高&#x27;, &#x27;智能&#x27;, &#x27;未来&#x27;, &#x27;充满&#x27;, &#x27;潜力&#x27;, &#x27;大&#x27;, &#x27;数据&#x27;, &#x27;支持&#x27;, &#x27;发展&#x27;, &#x27;关键&#x27;, &#x27;量子&#x27;, &#x27;隧穿&#x27;, &#x27;效应&#x27;, &#x27;电子&#x27;, &#x27;穿过&#x27;, &#x27;经典力学&#x27;, &#x27;势垒&#x27;, &#x27;半导体器件&#x27;], &#x27;idf_value&#x27;: [0.7621400520468966, 1.2237754316221157, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.2237754316221157, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.2237754316221157, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.2237754316221157, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.2237754316221157, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331, 1.845826690498331], &#x27;k1&#x27;: 1.5, &#x27;b&#x27;: 0.75, &#x27;epsilon&#x27;

 `idf_word` 是 BM25对文档集合的分词结果，也就是前面提到的词汇表。词汇表中单词的数量，也是稀疏向量的维度。
<hexoPostRenderCodeBlock><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># BM25词汇表中的单词数量</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;BM25词汇表中的单词数量：<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(bm25_params[<span class="hljs-string">&#x27;idf_word&#x27;</span>])&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># BM25稀疏向量的维度</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;BM25稀疏向量维度：<span class="hljs-subst">&#123;bm25_ef.dim&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>返回的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BM25词汇表中的单词数量：46<br>BM25稀疏向量维度：46<br></code></pre></td></tr></table></figure>

<p>需要的参数计算好了，接下来就可以生成文档集合的稀疏向量了。文档集合中有10篇文档，也就是10个字符串，而稀疏向量的维度是46，所以文档集合的稀疏向量是一个10行46列的矩阵。每一行表示一个文档的稀疏向量。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 生成文档集合的稀疏向量</span><br>sparse_vectors_bm25 = bm25_ef.encode_documents(docs)<br><br><span class="hljs-comment"># 打印文档集合的稀疏向量</span><br><span class="hljs-built_in">print</span>(sparse_vectors_bm25)<br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">(0, 0)	1.0344827586206897<br>(0, 1)	1.0344827586206897<br>(0, 2)	1.0344827586206897<br>(0, 3)	1.0344827586206897<br>(0, 4)	1.0344827586206897<br>:	:<br>(9, 7)	0.7228915662650603<br>(9, 38)	0.7228915662650603<br>(9, 39)	0.7228915662650603<br>(9, 40)	0.7228915662650603<br>(9, 41)	0.7228915662650603<br>(9, 42)	1.1214953271028039<br>(9, 43)	0.7228915662650603<br>(9, 44)	0.7228915662650603<br>(9, 45)	0.7228915662650603<br></code></pre></td></tr></table></figure>

<p>我们来看下第一个文档“机器学习正在改变我们的生活方式。”的稀疏向量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 第一个文档的稀疏向量</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(sparse_vectors_bm25)[<span class="hljs-number">0</span>])<br></code></pre></td></tr></table></figure>

<p>结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">(0, 0)	1.0344827586206897<br>(0, 1)	1.0344827586206897<br>(0, 2)	1.0344827586206897<br>(0, 3)	1.0344827586206897<br>(0, 4)	1.0344827586206897<br></code></pre></td></tr></table></figure>

<p>你发现了吧，第一个文档的稀疏向量只有5个非零元素，因为它的分词结果是5个单词，对应上了。而且，每个元素的值都相同，说明它们的逆文档频率 IDF 和词频 TF 都是一样的。</p>
<p>第一个文档的分词结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[&#x27;机器&#x27;, &#x27;学习&#x27;, &#x27;改变&#x27;, &#x27;生活&#x27;, &#x27;方式&#x27;]<br></code></pre></td></tr></table></figure>

<p>文档集合处理好了，我们再给出一个查询的句子，就可以执行搜索了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">query = [<span class="hljs-string">&quot;自动驾驶如何影响汽车行业？&quot;</span>]<br><br><span class="hljs-comment"># 把查询文本向量化</span><br>query_sparse_vectors_bm25 = bm25_ef.encode_queries(query)<br><br><span class="hljs-comment"># 打印稀疏向量</span><br><span class="hljs-built_in">print</span>(query_sparse_vectors_bm25)<br><br><span class="hljs-comment"># 查询的分词结果</span><br><span class="hljs-built_in">print</span>(analyzer(query[<span class="hljs-number">0</span>]))<br></code></pre></td></tr></table></figure>

<p>查看查询的稀疏向量，以及它的分词结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">  (0, 12)	1.845826690498331<br>  (0, 13)	1.845826690498331<br>[&#x27;自动&#x27;, &#x27;驾驶&#x27;, &#x27;影响&#x27;, &#x27;汽车行业&#x27;]<br></code></pre></td></tr></table></figure>

<p>你可能会有疑问，为什么查询分词后得到4个单词，但是它的稀疏向量只有2维？因为这4个单词中，词汇表中只有“自动”和“驾驶”，没有“影响”和“汽车行业”，后两个词的 BM25 分数为0。</p>
<p>哎，毕竟是门外汉啊。</p>
<h2 id="刚入门的新人——splade"><a href="#刚入门的新人——splade" class="headerlink" title="刚入门的新人——splade"></a>刚入门的新人——splade</h2><p>如果说稠密向量是精通特定领域的专家，统计得到的稀疏向量 BM25是聪明的门外汉，那么学习得到的稀疏向量 splade 就是刚入门的新人。他理解领域内专业术语的语义，而且能够举一反三，增加更多语义相近的词，一起查找。但是他毕竟还是新人，并不精通，还是通过数专业术语出现的次数，找到最相关的文档。</p>
<p>具体来说，splade 是这样工作的：<br>首先，splade 先对句子分词，通过嵌入模型 BERT （BERT 相关内容详见 [[02-孙悟空 + 红楼梦 - 西游记 &#x3D; ？向量嵌入之稠密向量]]）得到单词的向量。向量可以表达语义，所以 splade 能够“举一反三”，找到更多语义相似的单词。</p>
<p>比如，对于“人工智能如何影响汽车行业”这个句子，分词得到“人工智能”和“汽车”两个 单词，以及与“人工智能”相似的“AI”等单词。</p>
<p>splade 也有一张词汇表，不过它不需要像 bm25 那样根据文档集合统计，而是预先就有的，来源于 BERT。</p>
<p>接下来，splade 生成这些单词的稀疏向量。它会计算每个单词出现在词汇表中的每个位置的概率。也就是说，单词和词汇表中某个位置的词在语义上越接近，计算得到的概率越大。这个概率就是单词的权重。</p>
<p>以“人工智能”为例，假设词汇表中第5个词也是“人工智能”，两个词完全一样，计算得到的概率就很高，比如40%。而词汇表第8个词是“机器学习”，两个词比较相似，概率是20%。而词汇表中其他的词和“人工智能”语义相差较远，概率很小，忽略不计。最后，“人工智能”的权重就是 $40% + 20% &#x3D; 60%$。</p>
<p>然后再用相同的方法，计算出“AI”和“汽车”的权重，得到稀疏向量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sparse_vector = &#123;<span class="hljs-string">&quot;人工智能&quot;</span>: <span class="hljs-number">0.6</span>,<span class="hljs-string">&quot;AI&quot;</span>: <span class="hljs-number">0.5</span>,<span class="hljs-string">&quot;汽车&quot;</span>: <span class="hljs-number">0.1</span>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="splade-代码实践"><a href="#splade-代码实践" class="headerlink" title="splade 代码实践"></a>splade 代码实践</h2><p>老规矩，我们还使用代码验证下前面的内容。这次使用英文的文档集合：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"># 使用英文<br>docs_en = [<br>    &quot;Machine learning is changing our way of life.&quot;,<br>    &quot;Deep learning performs exceptionally well in image recognition.&quot;,<br>    &quot;Natural language processing is an important field in computer science.&quot;,<br>    &quot;Autonomous driving relies on advanced algorithms.&quot;,<br>    &quot;AI can help doctors diagnose diseases.&quot;,<br>    &quot;Data analysis technology is widely applied in the financial field.&quot;,<br>    &quot;Production efficiency can be improved through automation technology.&quot;,<br>    &quot;The future of machine intelligence is full of potential.&quot;,<br>    &quot;Big data support is key to the development of machine intelligence.&quot;,<br>    &quot;The quantum tunneling effect allows electrons to pass through potential barriers that classical mechanics consider impassable, which has important applications in semiconductor devices.&quot;<br>]<br></code></pre></td></tr></table></figure>

<p>生成文档集合的稀疏向量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pymilvus.model.sparse <span class="hljs-keyword">import</span> SpladeEmbeddingFunction<br><br>query_en = [<span class="hljs-string">&quot;How does artificial intelligence affect the automotive industry?&quot;</span>]<br><br>model_name = <span class="hljs-string">&quot;naver/splade-cocondenser-selfdistil&quot;</span><br><br><span class="hljs-comment"># 实例化splade嵌入模型</span><br>splade_ef = SpladeEmbeddingFunction(<br>    model_name = model_name, <br>    device=<span class="hljs-string">&quot;cpu&quot;</span><br>)<br><br><span class="hljs-comment"># 生成文档集合的稀疏向量</span><br>sparse_vectors_splade = splade_ef.encode_documents(docs_en)<br><span class="hljs-built_in">print</span>(sparse_vectors_splade)<br></code></pre></td></tr></table></figure>

<p>和 BM25 一样，我们同样得到一个稀疏向量矩阵：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">(0, 1012)	0.053256504237651825<br>(0, 2003)	0.22995686531066895<br>(0, 2047)	0.08765587955713272<br>:	:<br>(9, 27630)	0.2794925272464752<br>(9, 28688)	0.02786295674741268<br>(9, 28991)	0.12241243571043015<br></code></pre></td></tr></table></figure>

<p>splade 的词汇表是预先准备好的，词汇表中的单词数量同样也是稀疏向量的维度。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># splade词汇表中的单词数量</span><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForMaskedLM, AutoTokenizer<br>tokenizer = AutoTokenizer.from_pretrained(model_name)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;splade词汇表中的单词数量：<span class="hljs-subst">&#123;tokenizer.vocab_size&#125;</span>&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;splade稀疏向量维度：<span class="hljs-subst">&#123;splade_ef.dim&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>二者相同：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">splade词汇表中的单词数量：30522<br>splade稀疏向量维度：30522<br></code></pre></td></tr></table></figure>

<p>我们再来看看查询的分词结果及其稀疏向量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 查看查询的分词</span><br>tokens = tokenizer.tokenize(query_en[<span class="hljs-number">0</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;“<span class="hljs-subst">&#123;query_en[<span class="hljs-number">0</span>]&#125;</span>” 的分词结果：\n<span class="hljs-subst">&#123;tokens&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;tokens数量：<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(tokens)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># 生成查询的稀疏向量</span><br>query_sparse_vectors_splade = splade_ef.encode_queries(query_en)<br><span class="hljs-built_in">print</span>(query_sparse_vectors_splade)<br></code></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">“How does artificial intelligence affect the automotive industry?” 的分词结果：<br>[&#x27;how&#x27;, &#x27;does&#x27;, &#x27;artificial&#x27;, &#x27;intelligence&#x27;, &#x27;affect&#x27;, &#x27;the&#x27;, &#x27;automotive&#x27;, &#x27;industry&#x27;, &#x27;?&#x27;]<br><br>tokens数量：9<br><br>  (0, 2054)	0.139632448554039<br>  (0, 2079)	0.08572433888912201<br>  (0, 2106)	0.22006677091121674<br>  (0, 2126)	0.038961488753557205<br>  (0, 2129)	0.6875206232070923<br>  (0, 2138)	0.5343469381332397<br>  (0, 2194)	0.32417890429496765<br>  (0, 2224)	0.011731390841305256<br>  (0, 2339)	0.33811360597610474<br>  :	:<br>  (0, 26060)	0.0731586366891861<br></code></pre></td></tr></table></figure>

<p>比较分词的数量和稀疏向量的维度，你有没有发现有什么不对劲的地方？没错，分词数量和稀疏向量的维度不一样。这就是 splade 和 BM25的重要区别，splade 能够“举一反三”，它在最初9个分词的基础上，又增加了其他语义相近的单词。</p>
<p>那么，查询现在一共有多少个单词呢？或者说，它的稀疏向量的非零元素有多少呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取稀疏向量的非零索引</span><br>nonzero_indices = query_sparse_vectors_splade.indices[query_sparse_vectors_splade.indptr[<span class="hljs-number">0</span>]:query_sparse_vectors_splade.indptr[<span class="hljs-number">1</span>]]<br><br><span class="hljs-comment"># 构建稀疏词权重列表</span><br>sparse_token_weights = [<br>    (splade_ef.model.tokenizer.decode(col), query_sparse_vectors_splade[<span class="hljs-number">0</span>, col])<br>    <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> nonzero_indices<br>]<br><br><span class="hljs-comment"># 按权重降序排序</span><br>sparse_token_weights = <span class="hljs-built_in">sorted</span>(sparse_token_weights, key=<span class="hljs-keyword">lambda</span> item: item[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 查询句只有9个tokens，splade通过举一反三，生成的稀疏向量维度增加到了98个。</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;splade 稀疏向量非零元素数量：<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(sparse_token_weights)&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>一共有98个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">splade 稀疏向量非零元素数量：98<br></code></pre></td></tr></table></figure>

<p>具体是哪些单词？我们打印出来看一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 比如，和“artificial intelligence”语义相近的 “ai”，和“automotive”语义相近的“car”。</span><br><span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> sparse_token_weights:<br>    <span class="hljs-built_in">print</span>(token)<br></code></pre></td></tr></table></figure>

<p>splade 增加了大量语义相近的单词，比如和“artificial intelligence”语义相近的 “ai”，和“automotive”语义相近的“car”和“vehicle”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">(&#x27;artificial&#x27;, 2.588431)<br>(&#x27;intelligence&#x27;, 2.3582284)<br>(&#x27;car&#x27;, 1.590975)<br>(&#x27;automotive&#x27;, 1.4835068)<br>(&#x27;vehicle&#x27;, 0.798108)<br>(&#x27;ai&#x27;, 0.676852)<br>  :	:<br></code></pre></td></tr></table></figure>

<h2 id="搜索实践"><a href="#搜索实践" class="headerlink" title="搜索实践"></a>搜索实践</h2><p>我们已经了解了两种稀疏向量的特点，以及生成方法，下面就在搜索中体会下它们的区别吧。</p>
<p>我们需要用 Milvus 创建集合，然后导入数据，创建索引，加载数据，就可以搜索了。这个过程我在 [[01-如何假装文艺青年，怎么把大白话“变成”古诗词？]]中有详细介绍，就不多赘述了。</p>
<p>创建集合。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pymilvus <span class="hljs-keyword">import</span> MilvusClient, DataType<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-comment"># 删除同名集合</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_collection</span>(<span class="hljs-params">collection_name</span>):<br>    <span class="hljs-keyword">if</span> milvus_client.has_collection(collection_name):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;集合 <span class="hljs-subst">&#123;collection_name&#125;</span> 已经存在&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            milvus_client.drop_collection(collection_name)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;删除集合：<span class="hljs-subst">&#123;collection_name&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;删除集合时出现错误: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><br><span class="hljs-comment"># 创建模式</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_schema</span>():<br>    schema = milvus_client.create_schema(<br>        auto_id=<span class="hljs-literal">True</span>,<br>        enable_dynamic_field=<span class="hljs-literal">True</span>,<br>        num_partitions=<span class="hljs-number">16</span>,<br>        description=<span class="hljs-string">&quot;&quot;</span><br>    )<br>    <span class="hljs-comment"># 添加字段到schema</span><br>    schema.add_field(field_name=<span class="hljs-string">&quot;id&quot;</span>, datatype=DataType.INT64, is_primary=<span class="hljs-literal">True</span>, max_length=<span class="hljs-number">256</span>)<br>    schema.add_field(field_name=<span class="hljs-string">&quot;text&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="hljs-number">256</span>)<br>    <span class="hljs-comment"># bm25稀疏向量</span><br>    schema.add_field(field_name=<span class="hljs-string">&quot;sparse_vectors_bm25&quot;</span>, datatype=DataType.SPARSE_FLOAT_VECTOR)<br>    <span class="hljs-comment"># splade稀疏向量</span><br>    schema.add_field(field_name=<span class="hljs-string">&quot;sparse_vectors_splade&quot;</span>, datatype=DataType.SPARSE_FLOAT_VECTOR)<br>    <span class="hljs-keyword">return</span> schema<br><br><br><span class="hljs-comment"># 创建集合</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_collection</span>(<span class="hljs-params">collection_name, schema, timeout = <span class="hljs-number">3</span></span>):<br>    <span class="hljs-comment"># 创建集合</span><br>    <span class="hljs-keyword">try</span>:<br>        milvus_client.create_collection(<br>            collection_name=collection_name,<br>            schema=schema,<br>            shards_num=<span class="hljs-number">2</span><br>        )<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;开始创建集合：<span class="hljs-subst">&#123;collection_name&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;创建集合的过程中出现了错误: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 检查集合是否创建成功</span><br>    start_time = time.time()<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">if</span> milvus_client.has_collection(collection_name):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;集合 <span class="hljs-subst">&#123;collection_name&#125;</span> 创建成功&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">elif</span> time.time() - start_time &gt; timeout:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;创建集合 <span class="hljs-subst">&#123;collection_name&#125;</span> 超时&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        time.sleep(<span class="hljs-number">1</span>)<br><br><br><span class="hljs-comment"># 定义删除集合失败的异常类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CollectionDeletionError</span>(<span class="hljs-title class_ inherited__">Exception</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;删除集合失败&quot;&quot;&quot;</span><br><br>collection_name = <span class="hljs-string">&quot;docs&quot;</span><br>uri=<span class="hljs-string">&quot;http://localhost:19530&quot;</span><br>milvus_client = MilvusClient(uri=uri)<br>check_collection(collection_name)<br><br><span class="hljs-comment"># 检查并删除同名集合</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_collection(collection_name):<br>    <span class="hljs-comment"># 无法删除集合，抛出异常</span><br>    <span class="hljs-keyword">raise</span> CollectionDeletionError(<span class="hljs-string">&#x27;删除集合失败&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment"># 创建集合的模式</span><br>    schema = create_schema()<br>    <span class="hljs-comment"># 创建集合并等待成功</span><br>    create_collection(collection_name, schema)<br></code></pre></td></tr></table></figure>

<p>导入数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 准备数据</span><br>entities = [<br>    &#123;<br>        <span class="hljs-comment"># 文本字段</span><br>        <span class="hljs-string">&quot;text&quot;</span>: docs[i],<br>        <span class="hljs-string">&quot;text_en&quot;</span>: docs_en[i],<br>        <span class="hljs-comment"># bm25稀疏向量字段</span><br>        <span class="hljs-string">&quot;sparse_vectors_bm25&quot;</span>: <span class="hljs-built_in">list</span>(sparse_vectors_bm25)[i].reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>),<br>        <span class="hljs-comment"># splade稀疏向量字段</span><br>        <span class="hljs-string">&quot;sparse_vectors_splade&quot;</span>: <span class="hljs-built_in">list</span>(sparse_vectors_splade)[i].reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>),<br>    &#125;<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(docs))<br>]<br><br><span class="hljs-comment"># 导入数据</span><br>milvus_client.insert(collection_name=collection_name, data=entities)<br></code></pre></td></tr></table></figure>

<p>创建索引。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 创建索引参数</span><br>index_params = milvus_client.prepare_index_params()<br><br><span class="hljs-comment"># 为稀疏向量bm25创建索引参数</span><br>index_params.add_index(<br>    index_name=<span class="hljs-string">&quot;sparse_vectors_bm25&quot;</span>,<br>    field_name=<span class="hljs-string">&quot;sparse_vectors_bm25&quot;</span>,<br>    <span class="hljs-comment"># SPARSE_INVERTED_INDEX是传统的倒排索引，SPARSE_WAND使用Weak-AND算法来减少搜索过程中的完整IP距离计算</span><br>    index_type=<span class="hljs-string">&quot;SPARSE_INVERTED_INDEX&quot;</span>,<br>    <span class="hljs-comment"># 目前仅支持IP</span><br>    metric_type=<span class="hljs-string">&quot;IP&quot;</span>,<br>    <span class="hljs-comment"># 创建索引时，排除向量值最小的20%的向量。对于稀疏向量来说，向量值越大，说明在该维度上的重要性越大。范围[0,1]。</span><br>    params=&#123;<span class="hljs-string">&quot;drop_ratio_build&quot;</span>: <span class="hljs-number">0.2</span>&#125;<br>)<br><br><br><span class="hljs-comment"># 为稀疏向量splade创建索引参数</span><br>index_params.add_index(<br>    index_name=<span class="hljs-string">&quot;sparse_vectors_splade&quot;</span>,<br>    field_name=<span class="hljs-string">&quot;sparse_vectors_splade&quot;</span>,<br>    <span class="hljs-comment"># SPARSE_INVERTED_INDEX是传统的倒排索引，SPARSE_WAND使用Weak-AND算法来减少搜索过程中的完整IP距离计算</span><br>    index_type=<span class="hljs-string">&quot;SPARSE_INVERTED_INDEX&quot;</span>,<br>    <span class="hljs-comment"># 目前仅支持IP</span><br>    metric_type=<span class="hljs-string">&quot;IP&quot;</span>,<br>    <span class="hljs-comment"># 创建索引时，排除向量值最小的20%的向量。对于稀疏向量来说，向量值越大，说明在该维度上的重要性越大。范围[0,1]。</span><br>    params=&#123;<span class="hljs-string">&quot;drop_ratio_build&quot;</span>: <span class="hljs-number">0.2</span>&#125;<br>)<br><br><span class="hljs-comment"># 创建索引</span><br>milvus_client.create_index(<br>    collection_name=collection_name,<br>    index_params=index_params<br>)<br></code></pre></td></tr></table></figure>

<p>查看索引是否创建成功。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 查看索引信息</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show_index_info</span>(<span class="hljs-params">collection_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    显示指定集合中某个索引的详细信息。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    collection_name (str): 集合的名称。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回:</span><br><span class="hljs-string">    None: 该函数仅打印索引信息，不返回任何值。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 查看集合的所有索引</span><br>    indexes = milvus_client.list_indexes(<br>        collection_name=collection_name  <br>    )<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;已经创建的索引：<span class="hljs-subst">&#123;indexes&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>()<br>    <span class="hljs-comment"># 查看索引信息</span><br>    <span class="hljs-keyword">if</span> indexes:<br>        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> indexes:<br>            index_details = milvus_client.describe_index(<br>                collection_name=collection_name,  <br>                <span class="hljs-comment"># 指定索引名称，这里假设使用第一个索引</span><br>                index_name=index<br>            )<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;索引 <span class="hljs-subst">&#123;index&#125;</span> 详情：<span class="hljs-subst">&#123;index_details&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;集合 <span class="hljs-subst">&#123;collection_name&#125;</span> 中没有创建索引。&quot;</span>)<br><br><span class="hljs-comment"># 示例</span><br>show_index_info(collection_name)<br></code></pre></td></tr></table></figure>

<p>如果创建成功，你会看到下面的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">已经创建的索引：[&#x27;sparse_vectors_bm25&#x27;, &#x27;sparse_vectors_splade&#x27;]<br><br>索引 sparse_vectors_bm25 详情：&#123;&#x27;drop_ratio_build&#x27;: &#x27;0.2&#x27;, &#x27;index_type&#x27;: &#x27;SPARSE_INVERTED_INDEX&#x27;, &#x27;metric_type&#x27;: &#x27;IP&#x27;, &#x27;field_name&#x27;: &#x27;sparse_vectors_bm25&#x27;, &#x27;index_name&#x27;: &#x27;sparse_vectors_bm25&#x27;, &#x27;total_rows&#x27;: 0, &#x27;indexed_rows&#x27;: 0, &#x27;pending_index_rows&#x27;: 0, &#x27;state&#x27;: &#x27;Finished&#x27;&#125;<br><br>索引 sparse_vectors_splade 详情：&#123;&#x27;drop_ratio_build&#x27;: &#x27;0.2&#x27;, &#x27;index_type&#x27;: &#x27;SPARSE_INVERTED_INDEX&#x27;, &#x27;metric_type&#x27;: &#x27;IP&#x27;, &#x27;field_name&#x27;: &#x27;sparse_vectors_splade&#x27;, &#x27;index_name&#x27;: &#x27;sparse_vectors_splade&#x27;, &#x27;total_rows&#x27;: 0, &#x27;indexed_rows&#x27;: 0, &#x27;pending_index_rows&#x27;: 0, &#x27;state&#x27;: &#x27;Finished&#x27;&#125;<br></code></pre></td></tr></table></figure>

<p>加载集合。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 加载集合</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;正在加载集合：<span class="hljs-subst">&#123;collection_name&#125;</span>&quot;</span>)<br>milvus_client.load_collection(collection_name=collection_name)<br><br><span class="hljs-comment"># 验证加载状态</span><br><span class="hljs-built_in">print</span>(milvus_client.get_load_state(collection_name=collection_name))<br></code></pre></td></tr></table></figure>

<p>如果加载成功，会显示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">正在加载集合：docs<br>&#123;&#x27;state&#x27;: &lt;LoadState: Loaded&gt;&#125;<br></code></pre></td></tr></table></figure>

<p>加载完成，下面就是重头戏了，搜索。</p>
<p>定义搜索函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 定义稀疏向量搜索参数</span><br>search_params_sparse_vectors = &#123;<br>    <span class="hljs-string">&quot;metric_type&quot;</span>: <span class="hljs-string">&quot;IP&quot;</span>,<br>    <span class="hljs-string">&quot;params&quot;</span>: &#123;<span class="hljs-string">&quot;drop_ratio_search&quot;</span>: <span class="hljs-number">0.2</span>&#125;,<br>&#125;<br><br><span class="hljs-comment"># 执行向量搜索</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vector_search</span>(<span class="hljs-params"></span><br><span class="hljs-params">        query_vectors,</span><br><span class="hljs-params">        field_name,</span><br><span class="hljs-params">        search_params,</span><br><span class="hljs-params">        output_fields,</span><br><span class="hljs-params">    </span>):<br>    <span class="hljs-comment"># 向量搜索</span><br>    res = milvus_client.search(<br>        collection_name=collection_name,<br>        <span class="hljs-comment"># 指定查询向量。</span><br>        data=query_vectors,<br>        <span class="hljs-comment"># 指定要搜索的向量字段</span><br>        anns_field=field_name,<br>        <span class="hljs-comment"># 设置搜索参数</span><br>        search_params=search_params,<br>        output_fields=output_fields<br>    )<br>    <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure>

<p>再定义一个打印结果的函数，方便查看结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 打印向量搜索结果</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_vector_results</span>(<span class="hljs-params">res</span>):<br>    <span class="hljs-keyword">for</span> hits <span class="hljs-keyword">in</span> res:<br>        <span class="hljs-keyword">for</span> hit <span class="hljs-keyword">in</span> hits:<br>            entity = hit.get(<span class="hljs-string">&quot;entity&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;text: <span class="hljs-subst">&#123;entity[<span class="hljs-string">&#x27;text&#x27;</span>]&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;distance: <span class="hljs-subst">&#123;hit[<span class="hljs-string">&#x27;distance&#x27;</span>]:<span class="hljs-number">.3</span>f&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span>*<span class="hljs-number">50</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;数量：<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(hits)&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>首先，我们使用 BM25搜索。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用稀疏向量BM25搜索</span><br>query1 = [<span class="hljs-string">&quot;人工智能如何影响汽车行业？&quot;</span>]<br><br>query_sparse_vectors_bm25 = bm25_ef.encode_queries(query1)<br><br>field_name = <span class="hljs-string">&quot;sparse_vectors_bm25&quot;</span><br>output_fields = [<span class="hljs-string">&quot;text&quot;</span>]<br><span class="hljs-comment"># 指定搜索的分区，或者过滤搜索</span><br>res_sparse_vectors_bm25 = vector_search(query_sparse_vectors_bm25, field_name, search_params_sparse_vectors, output_fields)<br><br>print_vector_results(res_sparse_vectors_bm25)<br></code></pre></td></tr></table></figure>

<p>但是并没有搜索到任何结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">数量：0<br></code></pre></td></tr></table></figure>

<p>为什么呢？我们查看下 query1的分词结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 查看query1的分词结果</span><br><span class="hljs-built_in">print</span>(analyzer(query1[<span class="hljs-number">0</span>]))<br></code></pre></td></tr></table></figure>

<p>分词结果只有“人工智能”一个词：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[&#x27;人工智能&#x27;, &#x27;影响&#x27;, &#x27;汽车行业&#x27;]<br></code></pre></td></tr></table></figure>

<p>BM25的词汇表中虽然有“智能”这个词，但是并不包含“人工智能”、“影响”和“汽车行业”这些词，所以没有返回任何结果。</p>
<p>我们把“人工智能”替换成“机器智能”，就可以搜索到了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用稀疏向量BM25搜索</span><br>query2 = [<span class="hljs-string">&quot;机器智能如何影响汽车行业？&quot;</span>]<br><br>query_sparse_vectors_bm25 = bm25_ef.encode_queries(query2)<br><br>field_name = <span class="hljs-string">&quot;sparse_vectors_bm25&quot;</span><br>output_fields = [<span class="hljs-string">&quot;text&quot;</span>]<br><span class="hljs-comment"># 指定搜索的分区，或者过滤搜索</span><br>res_sparse_vectors_bm25 = vector_search(query_sparse_vectors_bm25, field_name, search_params_sparse_vectors, output_fields)<br><br>print_vector_results(res_sparse_vectors_bm25)<br></code></pre></td></tr></table></figure>

<p>而且，这次还搜索到了包含“机器学习”的句子。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">text: 机器智能的未来充满潜力。<br>distance: 2.054<br>--------------------------------------------------<br>text: 大数据支持是机器智能发展的关键。<br>distance: 1.752<br>--------------------------------------------------<br>text: 机器学习正在改变我们的生活方式。<br>distance: 0.788<br>--------------------------------------------------<br>数量：3<br></code></pre></td></tr></table></figure>

<p>这是因为分词时把“机器智能“分成了“机器”和“智能”两个词，所以能搜索到更多句子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 查看query2的分词结果</span><br><span class="hljs-built_in">print</span>(analyzer(query2[<span class="hljs-number">0</span>]))<br></code></pre></td></tr></table></figure>

<p>分词结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[&#x27;机器&#x27;, &#x27;智能&#x27;, &#x27;影响&#x27;, &#x27;汽车行业&#x27;]<br></code></pre></td></tr></table></figure>

<p>接下来，我们使用 splade 搜索，看看和 BM25的搜索结果有什么不同。</p>
<p>先定义一个打印结果的函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 打印向量搜索结果</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_vector_results_en</span>(<span class="hljs-params">res</span>):<br>    <span class="hljs-keyword">for</span> hits <span class="hljs-keyword">in</span> res:<br>        <span class="hljs-keyword">for</span> hit <span class="hljs-keyword">in</span> hits:<br>            entity = hit.get(<span class="hljs-string">&quot;entity&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;text_en: <span class="hljs-subst">&#123;entity[<span class="hljs-string">&#x27;text_en&#x27;</span>]&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;distance: <span class="hljs-subst">&#123;hit[<span class="hljs-string">&#x27;distance&#x27;</span>]:<span class="hljs-number">.3</span>f&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span>*<span class="hljs-number">50</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;数量：<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(hits)&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>然后使用 splade 搜索。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">query1_en = [<span class="hljs-string">&quot;How does artificial intelligence affect the automotive industry?&quot;</span>]<br><br>query_sparse_vectors_splade = splade_ef.encode_queries(query1_en)<br><br>field_name = <span class="hljs-string">&quot;sparse_vectors_splade&quot;</span><br>output_fields = [<span class="hljs-string">&quot;text_en&quot;</span>]<br>res_sparse_vectors_splade = vector_search(query_sparse_vectors_splade, field_name, search_params_sparse_vectors, output_fields)<br><br>print_vector_results_en(res_sparse_vectors_splade)<br></code></pre></td></tr></table></figure>

<p>比较 BM25 和 splade 的搜索结果，我们很容易发现它们之间的区别。splade 的文档集合中并不包含“artificial intelligence”这个词，但是由于它具有“举一反三”的能力，仍然搜索到了包含“AI”、“machine intelligence”以及“Autonomous”的句子，返回了更多结果（其实是返回了所有文档）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">text_en: The future of machine intelligence is full of potential.<br>distance: 10.020<br>--------------------------------------------------<br>text_en: Big data support is key to the development of machine intelligence.<br>distance: 8.232<br>--------------------------------------------------<br>text_en: AI can help doctors diagnose diseases.<br>distance: 7.291<br>--------------------------------------------------<br>text_en: Autonomous driving relies on advanced algorithms.<br>distance: 7.213<br>--------------------------------------------------<br>text_en: Production efficiency can be improved through automation technology.<br>distance: 6.999<br>--------------------------------------------------<br>text_en: Machine learning is changing our way of life.<br>distance: 6.863<br>--------------------------------------------------<br>text_en: Data analysis technology is widely applied in the financial field.<br>distance: 5.064<br>--------------------------------------------------<br>text_en: The quantum tunneling effect allows electrons to pass through potential barriers that classical mechanics consider impassable, which has important applications in semiconductor devices.<br>distance: 3.695<br>--------------------------------------------------<br>text_en: Deep learning performs exceptionally well in image recognition.<br>distance: 3.464<br>--------------------------------------------------<br>text_en: Natural language processing is an important field in computer science.<br>distance: 3.044<br>--------------------------------------------------<br>数量：10<br></code></pre></td></tr></table></figure>

<p>如果把查询中的“artificial intelligence”替换成“machine intelligence”，仍然会返回所有结果，但是权重有所不同。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">text_en: The future of machine intelligence is full of potential.<br>distance: 15.128<br>--------------------------------------------------<br>text_en: Big data support is key to the development of machine intelligence.<br>distance: 12.945<br>--------------------------------------------------<br>text_en: Machine learning is changing our way of life.<br>distance: 12.763<br>--------------------------------------------------<br>text_en: Production efficiency can be improved through automation technology.<br>distance: 7.446<br>--------------------------------------------------<br>text_en: AI can help doctors diagnose diseases.<br>distance: 6.055<br>--------------------------------------------------<br>text_en: Autonomous driving relies on advanced algorithms.<br>distance: 5.309<br>--------------------------------------------------<br>text_en: Data analysis technology is widely applied in the financial field.<br>distance: 4.857<br>--------------------------------------------------<br>text_en: The quantum tunneling effect allows electrons to pass through potential barriers that classical mechanics consider impassable, which has important applications in semiconductor devices.<br>distance: 3.356<br>--------------------------------------------------<br>text_en: Deep learning performs exceptionally well in image recognition.<br>distance: 3.317<br>--------------------------------------------------<br>text_en: Natural language processing is an important field in computer science.<br>distance: 2.688<br>--------------------------------------------------<br>数量：10<br></code></pre></td></tr></table></figure>

<h2 id="藏宝图"><a href="#藏宝图" class="headerlink" title="藏宝图"></a>藏宝图</h2><p>如果你想深入研究稀疏向量，可以参考下面的资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zilliz.com.cn/blog/mastering-bm25-a-deep-dive-into-the-algorithm-and-application-in-milvu">精通BM25：深入探讨算法及其在Milvus中的应用</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ZvId2vm8PDdA1fW3hJY1bA">详解如何通过稀疏向量优化信息检索</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/naver/splade">splade的github</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Okapi_BM25">BM25-wiki</a></li>
</ul>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>0.25&amp;#125;<br></code></pre></td></tr></table></figure></hexoPostRenderCodeBlock>
<a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:1" class="footnote-text"><span>BM25公式中并没有 epsilon 这个参数。在模型中，它用于平滑处理，以避免除以零的情况，特别是在文档长度（dl）为零的情况下。epsilon 通常是一个小的正数，如0.5，它被加到文档长度的归一化公式中，确保公式的稳定性。
<a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>门外汉如何“冒充”专家？向量嵌入之稀疏向量</div>
      <div>http://example.com/2024/12/11/门外汉如何“冒充”专家？向量嵌入之稀疏向量/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>爱写作的CAE工程师</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年12月11日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/01/07/%E5%86%99%E7%BB%99%E6%96%B0%E8%AF%BB%E8%80%85%E7%9A%84%E5%AF%BC%E8%88%AA/" title="写给新读者的导航">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">写给新读者的导航</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/10/29/%E9%B2%81%E8%BF%85%E5%88%B0%E5%BA%95%E8%AF%B4%E6%B2%A1%E8%AF%B4%EF%BC%9FRAG%E4%B9%8B%E5%88%86%E5%9D%97/" title="鲁迅到底说没说？RAG之分块">
                        <span class="hidden-mobile">鲁迅到底说没说？RAG之分块</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
